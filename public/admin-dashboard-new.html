<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beesoft Admin Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Source+Code+Pro:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #00ff00;
      --primary-hover: #00cc00;
      --secondary: #c0c0c0;
      --success: #00ff00;
      --warning: #ffff00;
      --error: #ff0000;
      --bg-primary: #000000;
      --bg-secondary: #0c0c0c;
      --bg-tertiary: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #c0c0c0;
      --text-muted: #808080;
      --border: #333333;
      --border-light: #555555;
      --shadow: none;
      --shadow-lg: none;
      --radius: 0px;
      --radius-lg: 0px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', 'Source Code Pro', 'Fira Code', 'Consolas', 'Monaco', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.4;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    /* Terminal-like scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border: 1px solid var(--text-muted);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Layout */
    .dashboard {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--bg-secondary);
      border-right: 2px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 2px solid var(--border);
      background: var(--bg-primary);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .logo::before {
      content: "C:\\BEESOFT>";
      color: var(--text-secondary);
      margin-right: 8px;
    }

    .logo i {
      color: var(--warning);
      font-size: 18px;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 0;
    }

    .nav-group {
      margin-bottom: 24px;
    }

    .nav-group-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 20px 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .nav-group-title::before {
      content: "[";
      color: var(--primary);
    }

    .nav-group-title::after {
      content: "]";
      color: var(--primary);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.1s ease;
      font-weight: 500;
      border-left: 3px solid transparent;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-item::before {
      content: ">";
      color: var(--text-muted);
      font-weight: bold;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .nav-item:hover::before {
      color: var(--primary);
      content: ">>";
    }

    .nav-item.active {
      background: var(--bg-tertiary);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .nav-item.active::before {
      color: var(--primary);
      content: ">>>";
    }

    .nav-item i {
      width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 2px solid var(--border);
      background: var(--bg-primary);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--primary);
      background: var(--bg-primary);
      font-size: 14px;
    }

    .user-details h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .user-details p {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .logout-btn {
      width: 100%;
      padding: 12px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.1s ease;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 11px;
    }

    .logout-btn:hover {
      background: var(--error);
      border-color: var(--error);
      color: var(--bg-primary);
    }

    .logout-btn::before {
      content: "EXEC: ";
      color: var(--text-muted);
    }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: 320px;
      background: var(--bg-primary);
    }

    .main-header {
      padding: 24px 24px 0;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border);
      background: var(--bg-secondary);
    }

    .page-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .page-title::before {
      content: "SYSTEM:\\";
      color: var(--text-muted);
      margin-right: 8px;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 12px;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .page-subtitle::before {
      content: "// ";
      color: var(--text-muted);
    }

    .main-content {
      padding: 0 24px 24px;
    }

    /* Cards */
    .card {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px;
      border-bottom: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-tertiary);
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-title::before {
      content: "[";
      color: var(--text-muted);
      margin-right: 4px;
    }

    .card-title::after {
      content: "]";
      color: var(--text-muted);
      margin-left: 4px;
    }

    .card-body {
      padding: 16px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      padding: 16px;
      transition: all 0.1s ease;
      position: relative;
    }

    .stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .stat-card:hover {
      border-color: var(--primary);
      background: var(--bg-tertiary);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .stat-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-icon {
      width: 24px;
      height: 24px;
      border: 1px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .stat-icon.primary { border-color: var(--primary); color: var(--primary); }
    .stat-icon.success { border-color: var(--success); color: var(--success); }
    .stat-icon.warning { border-color: var(--warning); color: var(--warning); }
    .stat-icon.error { border-color: var(--error); color: var(--error); }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
      font-family: inherit;
    }

    .stat-change {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change::before {
      content: "// ";
      color: var(--text-muted);
    }

    /* Tables */
    .table-container {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      overflow: hidden;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-family: inherit;
    }

    .table th {
      background: var(--bg-tertiary);
      padding: 12px 16px;
      text-align: left;
      font-weight: 700;
      color: var(--primary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid var(--border);
    }

    .table th::before {
      content: "[";
      color: var(--text-muted);
      margin-right: 4px;
    }

    .table th::after {
      content: "]";
      color: var(--text-muted);
      margin-left: 4px;
    }

    .table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 12px;
    }

    .table tbody tr:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border: 2px solid;
      font-weight: 600;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.1s ease;
      text-decoration: none;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: var(--bg-secondary);
    }

    .btn::before {
      content: "[";
      color: var(--text-muted);
    }

    .btn::after {
      content: "]";
      color: var(--text-muted);
    }

    .btn-primary {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary);
      color: var(--bg-primary);
    }

    .btn-success {
      border-color: var(--success);
      color: var(--success);
    }

    .btn-success:hover {
      background: var(--success);
      color: var(--bg-primary);
    }

    .btn-warning {
      border-color: var(--warning);
      color: var(--warning);
    }

    .btn-warning:hover {
      background: var(--warning);
      color: var(--bg-primary);
    }

    .btn-error {
      border-color: var(--error);
      color: var(--error);
    }

    .btn-error:hover {
      background: var(--error);
      color: var(--bg-primary);
    }

    .btn-outline {
      border-color: var(--border);
      color: var(--text-secondary);
    }

    .btn-outline:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--text-primary);
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--primary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-label::before {
      content: "INPUT: ";
      color: var(--text-muted);
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 2px solid var(--border);
      color: var(--text-primary);
      font-size: 12px;
      transition: all 0.1s ease;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--bg-tertiary);
    }

    .form-input::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border: 1px solid;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: inherit;
    }

    .status-badge::before {
      content: "[";
    }

    .status-badge::after {
      content: "]";
    }

    .status-online {
      border-color: var(--success);
      color: var(--success);
      background: rgba(0, 255, 0, 0.05);
    }

    .status-offline {
      border-color: var(--text-muted);
      color: var(--text-muted);
      background: rgba(128, 128, 128, 0.05);
    }

    .status-active {
      border-color: var(--success);
      color: var(--success);
      background: rgba(0, 255, 0, 0.05);
    }

    .status-expired {
      border-color: var(--error);
      color: var(--error);
      background: rgba(255, 0, 0, 0.05);
    }

    .status-warning {
      border-color: var(--warning);
      color: var(--warning);
      background: rgba(255, 255, 0, 0.05);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: var(--bg-secondary);
      border: 2px solid var(--primary);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-tertiary);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .modal-title::before {
      content: "EXEC: ";
      color: var(--text-muted);
    }

    .modal-close {
      background: none;
      border: 2px solid var(--error);
      color: var(--error);
      font-size: 16px;
      cursor: pointer;
      padding: 4px 8px;
      transition: all 0.1s ease;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: inherit;
      font-weight: bold;
    }

    .modal-close:hover {
      background: var(--error);
      color: var(--bg-primary);
    }

    .modal-body {
      padding: 16px;
    }

    .modal-footer {
      padding: 16px;
      border-top: 2px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: var(--bg-tertiary);
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .loading::before {
      content: "LOADING";
      margin-right: 8px;
      color: var(--primary);
    }

    .loading i {
      animation: spin 1s linear infinite;
      margin-left: 8px;
      color: var(--primary);
    }

    .loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ""; }
      40% { content: "."; }
      60% { content: ".."; }
      80%, 100% { content: "..."; }
    }

    /* Terminal prompt styles */
    .terminal-prompt {
      color: var(--primary);
      margin-right: 8px;
    }

    .terminal-prompt::before {
      content: "C:\\ADMIN>";
    }

    /* Blinking cursor */
    .cursor {
      animation: blink 1s infinite;
    }

    .cursor::after {
      content: "_";
      color: var(--primary);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 280px;
        transform: translateX(-100%);
        transition: transform 0.2s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main {
        margin-left: 0;
      }

      .main-header,
      .main-content {
        padding-left: 16px;
        padding-right: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 12px;
      }
    }

    /* ASCII Art Effects */
    .ascii-border {
      border: 2px solid var(--primary);
      position: relative;
    }

    .ascii-border::before {
      content: "┌─────────────────────────────────────────────────┐";
      position: absolute;
      top: -1px;
      left: -1px;
      color: var(--primary);
      font-size: 8px;
      line-height: 1;
    }

    .ascii-border::after {
      content: "└─────────────────────────────────────────────────┘";
      position: absolute;
      bottom: -1px;
      left: -1px;
      color: var(--primary);
      font-size: 8px;
      line-height: 1;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-bee"></i>
          <span>ADMIN</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-group">
          <div class="nav-group-title">SYSTEM</div>
          <a href="#" class="nav-item active" data-page="dashboard">
            <i class="fas fa-chart-line"></i>
            <span>DASHBOARD</span>
          </a>
        </div>
        
        <div class="nav-group">
          <div class="nav-group-title">MANAGEMENT</div>
          <a href="#" class="nav-item" data-page="devices">
            <i class="fas fa-desktop"></i>
            <span>DEVICES</span>
          </a>
          <a href="#" class="nav-item" data-page="licenses">
            <i class="fas fa-key"></i>
            <span>LICENSES</span>
          </a>
        </div>
        
        <div class="nav-group">
          <div class="nav-group-title">CONFIG</div>
          <a href="#" class="nav-item" data-page="settings">
            <i class="fas fa-cog"></i>
            <span>SETTINGS</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-details">
            <h4 id="username">ADMIN_USER</h4>
            <p>SUPERADMIN</p>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          LOGOUT
        </button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main">
      <div class="main-header">
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
        <p class="page-subtitle" id="pageSubtitle">Overview of your Beesoft system</p>
      </div>
      
      <div class="main-content" id="mainContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay hidden" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Modal Title</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        Modal content
      </div>
      <div class="modal-footer" id="modalFooter">
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="modalConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    const API_BASE = 'http://localhost:3001/api/admin';
    let authToken = localStorage.getItem('adminToken');
    let currentUser = localStorage.getItem('adminUsername');
    let currentPage = 'dashboard';

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      authToken = localStorage.getItem('adminToken');
      currentUser = localStorage.getItem('adminUsername');
      
      if (!authToken) {
        window.location.href = '/admin-login-secure.html';
        return;
      }
      
      initializeDashboard();
      loadPage('dashboard');
    });

    function initializeDashboard() {
      // Set user info
      if (currentUser) {
        document.getElementById('username').textContent = currentUser;
        document.getElementById('userAvatar').textContent = currentUser.charAt(0).toUpperCase();
      }
      
      // Add navigation event listeners
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.dataset.page;
          loadPage(page);
        });
      });
    }

    function loadPage(page) {
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      
      currentPage = page;
      
      // Update page title
      const titles = {
        dashboard: { title: 'DASHBOARD', subtitle: 'SYSTEM OVERVIEW AND STATISTICS' },
        devices: { title: 'DEVICE_MANAGEMENT', subtitle: 'CONNECTED DEVICES AND LICENSES' },
        licenses: { title: 'LICENSE_KEYS', subtitle: 'GENERATE AND MANAGE LICENSE KEYS' },
        settings: { title: 'SYSTEM_CONFIG', subtitle: 'ADMIN CONFIGURATION AND MANAGEMENT' }
      };
      
      document.getElementById('pageTitle').textContent = titles[page].title;
      document.getElementById('pageSubtitle').textContent = titles[page].subtitle;
      
      // Load page content
      switch (page) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'devices':
          loadDevices();
          break;
        case 'licenses':
          loadLicenses();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    }

    async function loadDashboard() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i></div>';
      
      try {
        // Fetch dashboard stats
        const deviceStats = await apiRequest('/devices/stats');
        const licenseStats = await apiRequest('/licenses/stats');
        
        mainContent.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">TOTAL_DEVICES</div>
                <div class="stat-icon primary">
                  <i class="fas fa-desktop"></i>
                </div>
              </div>
              <div class="stat-value">${deviceStats.totalDevices || 0}</div>
              <div class="stat-change">REGISTERED_DEVICES</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">ONLINE_DEVICES</div>
                <div class="stat-icon success">
                  <i class="fas fa-circle"></i>
                </div>
              </div>
              <div class="stat-value">${deviceStats.onlineDevices || 0}</div>
              <div class="stat-change">${deviceStats.offlineDevices || 0} OFFLINE</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">ACTIVE_LICENSES</div>
                <div class="stat-icon success">
                  <i class="fas fa-check-circle"></i>
                </div>
              </div>
              <div class="stat-value">${deviceStats.activeSubscriptions || 0}</div>
              <div class="stat-change">${deviceStats.permanentLicenses || 0} PERMANENT</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-title">AVAILABLE_KEYS</div>
                <div class="stat-icon warning">
                  <i class="fas fa-key"></i>
                </div>
              </div>
              <div class="stat-value">${licenseStats.availableKeys || 0}</div>
              <div class="stat-change">${licenseStats.usedKeys || 0} USED</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">RECENT_ACTIVITY</h3>
              <button class="btn btn-outline" onclick="loadPage('devices')">
                <i class="fas fa-external-link-alt"></i>
                VIEW_ALL
              </button>
            </div>
            <div class="card-body">
              <div id="recentActivity">LOADING_ACTIVITY...</div>
            </div>
          </div>
        `;
        
        // Load recent devices
        loadRecentActivity();
        
      } catch (error) {
        console.error('Error loading dashboard:', error);
        mainContent.innerHTML = '<div class="text-center">Error loading dashboard data</div>';
      }
    }

    async function loadRecentActivity() {
      try {
        const devices = await apiRequest('/devices?limit=5&sortBy=lastSeen&sortOrder=desc');
        const activityContainer = document.getElementById('recentActivity');
        
        if (devices.devices && devices.devices.length > 0) {
          activityContainer.innerHTML = `
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>DEVICE_ID</th>
                    <th>STATUS</th>
                    <th>LICENSE</th>
                    <th>LAST_SEEN</th>
                  </tr>
                </thead>
                <tbody>
                  ${devices.devices.map(device => `
                    <tr>
                      <td>
                        <div style="font-weight: 600; color: var(--primary);">${device.name || device.username}</div>
                        <div style="font-size: 10px; color: var(--text-muted); font-family: monospace;">${device.machineId}</div>
                      </td>
                      <td>
                        <span class="status-badge ${device.isOnline ? 'status-online' : 'status-offline'}">
                          ${device.isOnline ? 'ONLINE' : 'OFFLINE'}
                        </span>
                      </td>
                      <td>
                        <span class="status-badge status-${getSubscriptionStatusClass(device.subscriptionStatus)}">
                          ${getSubscriptionStatusText(device.subscriptionStatus).toUpperCase()}
                        </span>
                      </td>
                      <td>${formatTimeAgo(device.lastSeen)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          activityContainer.innerHTML = '<div class="text-center">NO_DEVICES_FOUND</div>';
        }
      } catch (error) {
        console.error('Error loading recent activity:', error);
        document.getElementById('recentActivity').innerHTML = '<div class="text-center">ERROR_LOADING_ACTIVITY</div>';
      }
    }

    async function loadSettings() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Password Management</h3>
          </div>
          <div class="card-body">
            <form id="updatePasswordForm" onsubmit="changePassword(event)">
              <!-- Hidden username field for accessibility -->
              <input type="text" name="username" id="passwordFormUsername" value="${currentUser || ''}" autocomplete="username" style="display:none;">
              <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" class="form-input" id="currentPassword" name="currentPassword" placeholder="Enter current password" required autocomplete="current-password">
              </div>
              <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-input" id="newPassword" name="newPassword" placeholder="Enter new password" required autocomplete="new-password">
              </div>
              <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" class="form-input" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required autocomplete="new-password">
              </div>
              <button type="submit" class="btn btn-primary">Update Password</button>
              <div id="passwordUpdateMsg" style="margin-top: 16px;"></div>
            </form>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Superadmin Management</h3>
            <button class="btn btn-primary" onclick="showCreateSuperadminModal()">
              <i class="fas fa-user-plus"></i>
              Create Superadmin
            </button>
          </div>
          <div class="card-body">
            <div id="superadminList">
              <div class="loading"><i class="fas fa-spinner"></i> Loading superadmins...</div>
            </div>
          </div>
        </div>
      `;
      
      // Load superadmin list
      loadSuperadminList();
      // Add: load device, trial, and license management features here (see backup for reference)
      // TODO: Integrate loadDevices, loadLicenses, and all related modals and actions from backup
    }

    async function loadSuperadminList() {
      const container = document.getElementById('superadminList');
      
      try {
        const response = await fetch(`${API_BASE}/list`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        const data = await response.json();
        console.log('Admin list response:', data);
        if (response.ok && Array.isArray(data.admins)) {
          if (data.admins.length === 0) {
            container.innerHTML = '<div class="text-center">No admins found.</div>';
          } else {
            container.innerHTML = `
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Username</th>
                      <th>Role</th>
                      <th>Created</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.admins.map(admin => {
                      console.log('Processing admin:', admin);
                      const displayName = admin.username || admin.userId || admin._id || 'Unknown';
                      const identifier = admin.username || admin.userId || admin._id;
                      return `
                      <tr>
                        <td style="font-weight: 600;">${displayName}</td>
                        <td>
                          <span class="status-badge status-active">
                            ${(admin.role || 'superadmin').charAt(0).toUpperCase() + (admin.role || 'superadmin').slice(1)}
                          </span>
                        </td>
                        <td>${admin.createdAt ? new Date(admin.createdAt).toLocaleDateString() : 'N/A'}</td>
                        <td>
                          <button class="btn btn-outline" onclick="showUpdatePasswordModal('${identifier}')">
                            <i class="fas fa-key"></i>
                            Update Password
                          </button>
                        </td>
                      </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `;
          }
        } else {
          container.innerHTML = '<div class="text-center">Error loading superadmins.</div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="text-center">Server error.</div>';
      }
    }


    function showCreateSuperadminModal() {
      showModal('Create Admin', `
        <form id="createAdminForm" onsubmit="event.preventDefault(); createAdmin();">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" class="form-input" id="newAdminUsername" placeholder="Enter username" required>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="newAdminPassword" placeholder="Enter password" required>
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select class="form-select" id="newAdminRole">
              <option value="superadmin">Superadmin</option>
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
            </select>
          </div>
          <div class="form-group" style="display: flex; justify-content: flex-end; gap: 8px;">
            <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Admin</button>
          </div>
        </form>
      `);
    }

    async function createAdmin() {
      const username = document.getElementById('newAdminUsername').value.trim();
      const password = document.getElementById('newAdminPassword').value;
      const role = document.getElementById('newAdminRole').value;
      if (!username || !password) {
        alert('Username and password are required');
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ username, password, role })
        });
        if (response.ok) {
          closeModal();
          alert('Admin created successfully');
          loadSuperadminList();
        } else {
          const data = await response.json();
          alert(data.error || 'Failed to create admin');
        }
      } catch (error) {
        alert('Server error');
      }
    }


    function showUpdatePasswordModal(username) {
      showModal('Update Password', `
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" value="${username}" disabled>
        </div>
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input type="password" class="form-input" id="updateAdminPassword" placeholder="Enter new password" required>
        </div>
      `, `
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="updateAdminPassword('${username}')">Update Password</button>
      `);
    }

    async function updateAdminPassword(username) {
      const password = document.getElementById('updateAdminPassword').value;
      if (!password) {
        alert('Password is required');
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ username, newPassword: password })
        });
        if (response.ok) {
          closeModal();
          alert('Password updated successfully');
        } else {
          alert('Failed to update password');
        }
      } catch (error) {
        alert('Server error');
      }
    }

    async function changePassword(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
      }
      
      if (newPassword.length < 6) {
        alert('New password must be at least 6 characters long');
        return;
      }
      
      const msgDiv = document.getElementById('passwordUpdateMsg');
      msgDiv.textContent = '';
      
      try {
        const response = await fetch(`${API_BASE}/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            username: currentUser,
            oldPassword: currentPassword,
            newPassword
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          msgDiv.style.color = 'var(--success)';
          msgDiv.textContent = 'Password updated successfully.';
          document.getElementById('updatePasswordForm').reset();
        } else {
          msgDiv.style.color = 'var(--error)';
          msgDiv.textContent = data.error || 'Failed to update password.';
        }
      } catch (error) {
        msgDiv.style.color = 'var(--error)';
        msgDiv.textContent = 'Server error.';
      }
    }

    // Placeholder functions for other pages
    // --- Device Management Page ---
    let currentDevicesPage = 1;
    let currentDevicesFilters = {};
    let deviceRefreshInterval;

    async function loadDevices() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = '<div class="loading"></div>';
      try {
        mainContent.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Device Management</h3>
              <div class="card-actions">
                <button class="btn btn-outline" onclick="refreshDevices()">
                  <i class="fas fa-sync-alt"></i>
                  Refresh
                </button>
                <button class="btn btn-primary" onclick="exportDevices()">
                  <i class="fas fa-download"></i>
                  Export
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="flex items-center gap-2 mb-4">
                <select class="form-select" id="statusFilter" onchange="filterDevices()" style="width: auto;">
                  <option value="">All Status</option>
                  <option value="online">Online</option>
                  <option value="offline">Offline</option>
                  <option value="banned">Banned</option>
                  <option value="active_subscription">Active License</option>
                  <option value="expired">Expired</option>
                </select>
                <select class="form-select" id="platformFilter" onchange="filterDevices()" style="width: auto;">
                  <option value="">All Platforms</option>
                  <option value="Windows">Windows</option>
                  <option value="macOS">macOS</option>
                  <option value="Linux">Linux</option>
                </select>
                <input type="text" class="form-input" id="searchInput" placeholder="Search devices..." onkeyup="searchDevices()" style="width: 300px;">
              </div>
              <div class="table-container">
                <table class="table" id="devicesTable">
                  <thead>
                    <tr>
                      <th>Device</th>
                      <th>Status</th>
                      <th>License</th>
                      <th>Platform</th>
                      <th>Last Seen</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="devicesTableBody">
                    <tr><td colspan="6" class="text-center">Loading devices...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div id="devicesPagination"></div>
                <div id="devicesCount"></div>
              </div>
            </div>
          </div>
        `;
        await refreshDevices();
        if (deviceRefreshInterval) clearInterval(deviceRefreshInterval);
        deviceRefreshInterval = setInterval(() => {
          if (currentPage === 'devices') refreshDevices();
        }, 30000);
      } catch (error) {
        mainContent.innerHTML = '<div class="text-center">Error loading devices page</div>';
      }
    }

    async function refreshDevices() {
      try {
        const params = new URLSearchParams({
          page: currentDevicesPage,
          limit: 20,
          sortBy: 'lastSeen',
          sortOrder: 'desc',
          ...currentDevicesFilters
        });
        const response = await apiRequest(`/devices?${params}`);
        displayDevices(response);
      } catch (error) {
        document.getElementById('devicesTableBody').innerHTML = '<tr><td colspan="6" class="text-center">Error loading devices</td></tr>';
      }
    }

    function displayDevices(data) {
      const tbody = document.getElementById('devicesTableBody');
      const pagination = document.getElementById('devicesPagination');
      const count = document.getElementById('devicesCount');
      if (!data.devices || data.devices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No devices found</td></tr>';
        pagination.innerHTML = '';
        count.innerHTML = '';
        return;
      }
      tbody.innerHTML = data.devices.map(device => `
        <tr>
          <td>
            <div>
              <div style="font-weight: 600;">${device.name || device.username}</div>
              <div style="font-size: 0.75rem; color: var(--vercel-secondary);">${device.machineId}</div>
              <div style="font-size: 0.75rem; color: var(--vercel-secondary);">${device.email || 'No email'}</div>
            </div>
          </td>
          <td>
            <span class="status-badge ${device.isOnline ? 'status-online' : 'status-offline'}">
              ${device.isOnline ? 'Online' : 'Offline'}
            </span>
            ${device.isBanned ? '<br><span class="status-badge status-banned">Banned</span>' : ''}
          </td>
          <td>
            <span class="status-badge status-${getSubscriptionStatusClass(device.subscriptionStatus)}">
              ${getSubscriptionStatusText(device.subscriptionStatus)}
            </span>
            ${device.subscription && device.subscription.type === 'trial' ? `
              <div style="margin-top: 0.5rem; font-size: 0.75rem;">
                <div>Messages: <span style="font-weight: bold; color: var(--vercel-accent);">${device.subscription.messageLimit !== undefined ? device.subscription.messageLimit : 'Unlimited'}</span></div>
                <div>Daily: <span style="font-weight: bold; color: var(--vercel-accent);">${device.subscription.dailyMessageLimit !== undefined ? device.subscription.dailyMessageLimit : 'Unlimited'}</span></div>
              </div>
            ` : ''}
            ${device.daysRemaining > 0 && device.daysRemaining < 9999 ? `<br><small>${device.daysRemaining} days left</small>` : ''}
          </td>
          <td>${device.platform || 'Unknown'}</td>
          <td>${formatTimeAgo(device.lastSeen)}</td>
          <td>
            <div class="flex gap-2">
              <button class="btn btn-outline" onclick="showDeviceActions('${device.machineId}')" title="Actions">
                <i class="fas fa-cog"></i>
              </button>
              <button class="btn btn-outline" onclick="editDevice('${device.machineId}')" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline" onclick="viewDeviceLogs('${device.machineId}')" title="Logs/Heartbeats">
                <i class="fas fa-history"></i>
              </button>
              ${device.isBanned ? 
                `<button class="btn btn-success" onclick="unbanDevice('${device.machineId}')" title="Unban">
                  <i class="fas fa-unlock"></i>
                </button>` :
                `<button class="btn btn-warning" onclick="banDevice('${device.machineId}')" title="Ban">
                  <i class="fas fa-ban"></i>
                </button>`
              }
              <button class="btn btn-danger" onclick="removeDevice('${device.machineId}')" title="Remove">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      const { page, pages, total } = data.pagination;
      let paginationHtml = '';
      if (pages > 1) {
        paginationHtml = '<div class="flex gap-2">';
        if (page > 1) {
          paginationHtml += `<button class="btn btn-outline" onclick="goToDevicesPage(${page - 1})">Previous</button>`;
        }
        for (let i = Math.max(1, page - 2); i <= Math.min(pages, page + 2); i++) {
          paginationHtml += `<button class="btn ${i === page ? 'btn-primary' : 'btn-outline'}" onclick="goToDevicesPage(${i})">${i}</button>`;
        }
        if (page < pages) {
          paginationHtml += `<button class="btn btn-outline" onclick="goToDevicesPage(${page + 1})">Next</button>`;
        }
        paginationHtml += '</div>';
      }
      pagination.innerHTML = paginationHtml;
      count.innerHTML = `Showing ${data.devices.length} of ${total} devices`;
    }

    function goToDevicesPage(page) {
      currentDevicesPage = page;
      refreshDevices();
    }

    function filterDevices() {
      const status = document.getElementById('statusFilter').value;
      const platform = document.getElementById('platformFilter').value;
      currentDevicesFilters = {};
      if (status) currentDevicesFilters.status = status;
      if (platform) currentDevicesFilters.platform = platform;
      currentDevicesPage = 1;
      refreshDevices();
    }

    function searchDevices() {
      const search = document.getElementById('searchInput').value.trim();
      if (search) {
        currentDevicesFilters.search = search;
      } else {
        delete currentDevicesFilters.search;
      }
      currentDevicesPage = 1;
      refreshDevices();
    }

    // Device actions, modals, and related functions (from backup)
    // --- Device Actions and Modals ---
    function showDeviceActions(machineId) {
      showModal('Device Actions', `
        <div class="form-group">
          <label class="form-label">Choose Action:</label>
          <div style="display: grid; gap: 1rem; margin-top: 1rem;">
            <button class="btn btn-success" onclick="closeModal(); activateTrialModal('${machineId}')">
              <i class="fas fa-clock"></i>
              Activate Trial
            </button>
            <button class="btn btn-primary" onclick="closeModal(); activatePermanentModal('${machineId}')">
              <i class="fas fa-key"></i>
              Activate Permanent License
            </button>
            <button class="btn btn-warning" onclick="closeModal(); updateMessageLimitsModal('${machineId}')">
              <i class="fas fa-comment"></i>
              Update Message Limits
            </button>
            <button class="btn btn-outline" onclick="closeModal(); viewDeviceLogs('${machineId}')">
              <i class="fas fa-history"></i>
              View Device Logs
            </button>
          </div>
        </div>
      `, '<button class="btn btn-outline" onclick="closeModal()">Close</button>');
    }

    function activateTrialModal(machineId) {
      showModal('Activate Trial License', `
        <div class="form-group">
          <label class="form-label">Trial Duration (Days):</label>
          <input type="number" class="form-input" id="trialDays" min="1" max="365" value="30" placeholder="Enter days (1-365)">
          <small style="color: var(--vercel-secondary);">Enter the number of days for the trial license</small>
        </div>
        <div class="form-group">
          <label class="form-label">Total Message Limit:</label>
          <input type="number" class="form-input" id="messageLimit" min="0" value="100" placeholder="Total messages (0 = unlimited)">
          <small style="color: var(--vercel-secondary);">Maximum total messages for the entire trial period</small>
        </div>
        <div class="form-group">
          <label class="form-label">Daily Message Limit:</label>
          <input type="number" class="form-input" id="dailyMessageLimit" min="0" value="50" placeholder="Daily messages (0 = unlimited)">
          <small style="color: var(--vercel-secondary);">Maximum messages per day</small>
        </div>
        <div class="form-group">
          <div style="background: var(--vercel-surface); padding: 1rem; border-radius: 8px; font-size: 0.875rem;">
            <strong>Trial Limits Summary:</strong><br>
            • Duration: <span id="durationSummary">30 days</span><br>
            • Total Messages: <span id="totalMessagesSummary">100 messages</span><br>
            • Daily Messages: <span id="dailyMessagesSummary">50 messages/day</span>
          </div>
        </div>
      `, `
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="activateTrial('${machineId}')">Activate Trial</button>
      `);
      setTimeout(() => {
        function updateTrialSummary() {
          const days = document.getElementById('trialDays').value || 30;
          const totalMessages = document.getElementById('messageLimit').value || 100;
          const dailyMessages = document.getElementById('dailyMessageLimit').value || 50;
          document.getElementById('durationSummary').textContent = days + ' days';
          document.getElementById('totalMessagesSummary').textContent = totalMessages == 0 ? 'Unlimited' : totalMessages + ' messages';
          document.getElementById('dailyMessagesSummary').textContent = dailyMessages == 0 ? 'Unlimited' : dailyMessages + ' messages/day';
        }
        document.getElementById('trialDays').addEventListener('input', updateTrialSummary);
        document.getElementById('messageLimit').addEventListener('input', updateTrialSummary);
        document.getElementById('dailyMessageLimit').addEventListener('input', updateTrialSummary);
      }, 100);
    }

    function activatePermanentModal(machineId) {
      showModal('Activate Permanent License', `
        <div class="form-group">
          <label class="form-label">License Key:</label>
          <input type="text" class="form-input" id="licenseKey" placeholder="XXXX-XXXX-XXXX-XXXX" style="text-transform: uppercase;">
          <small style="color: var(--vercel-secondary);">Enter a valid license key in format: XXXX-XXXX-XXXX-XXXX</small>
        </div>
      `, `
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="activatePermanent('${machineId}')">Activate License</button>
      `);
    }

    async function activateTrial(machineId) {
      const days = parseInt(document.getElementById('trialDays').value);
      const messageLimit = parseInt(document.getElementById('messageLimit').value) || 0;
      const dailyMessageLimit = parseInt(document.getElementById('dailyMessageLimit').value) || 0;
      if (!days || days < 1 || days > 365) {
        alert('Please enter a valid number of days (1-365)');
        return;
      }
      try {
        await apiRequest(`/devices/${machineId}/trial`, {
          method: 'POST',
          body: JSON.stringify({ days, messageLimit, dailyMessageLimit })
        });
        closeModal();
        alert(`Trial activated for ${days} days with message limits: ${messageLimit || 'unlimited'} total, ${dailyMessageLimit || 'unlimited'} daily`);
        refreshDevices();
      } catch (error) {
        alert('Failed to activate trial');
      }
    }

    async function activatePermanent(machineId) {
      const key = document.getElementById('licenseKey').value.trim().toUpperCase();
      if (!key) {
        alert('Please enter a license key');
        return;
      }
      const keyPattern = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
      if (!keyPattern.test(key)) {
        alert('Invalid key format. Use: XXXX-XXXX-XXXX-XXXX');
        return;
      }
      try {
        await apiRequest(`/devices/${machineId}/permanent`, {
          method: 'POST',
          body: JSON.stringify({ key })
        });
        closeModal();
        alert('Permanent license activated successfully');
        refreshDevices();
      } catch (error) {
        alert(error.message || 'Failed to activate permanent license');
      }
    }

    function updateMessageLimitsModal(machineId) {
      showModal('Update Message Limits', `
        <div class="form-group">
          <label class="form-label">Total Message Limit:</label>
          <input type="number" class="form-input" id="messageLimit" min="0" placeholder="Total messages (0 = unlimited)">
          <small style="color: var(--vercel-secondary);">Maximum total messages for the entire subscription period</small>
        </div>
        <div class="form-group">
          <label class="form-label">Daily Message Limit:</label>
          <input type="number" class="form-input" id="dailyMessageLimit" min="0" placeholder="Daily messages (0 = unlimited)">
          <small style="color: var(--vercel-secondary);">Maximum messages per day</small>
        </div>
        <div class="form-group">
          <div style="background: var(--vercel-surface); padding: 1rem; border-radius: 8px; font-size: 0.875rem;">
            <strong>Message Limits Summary:</strong><br>
            • Total Messages: <span id="totalMessagesSummary">Not set</span><br>
            • Daily Messages: <span id="dailyMessagesSummary">Not set</span>
          </div>
        </div>
      `, `
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-warning" onclick="updateMessageLimits('${machineId}')">Update Limits</button>
      `);
      setTimeout(() => {
        function updateLimitsSummary() {
          const totalMessages = document.getElementById('messageLimit').value;
          const dailyMessages = document.getElementById('dailyMessageLimit').value;
          document.getElementById('totalMessagesSummary').textContent = !totalMessages ? 'Not set' : (totalMessages == 0 ? 'Unlimited' : totalMessages + ' messages');
          document.getElementById('dailyMessagesSummary').textContent = !dailyMessages ? 'Not set' : (dailyMessages == 0 ? 'Unlimited' : dailyMessages + ' messages/day');
        }
        document.getElementById('messageLimit').addEventListener('input', updateLimitsSummary);
        document.getElementById('dailyMessageLimit').addEventListener('input', updateLimitsSummary);
      }, 100);
    }

    async function updateMessageLimits(machineId) {
      const messageLimit = parseInt(document.getElementById('messageLimit').value) || 0;
      const dailyMessageLimit = parseInt(document.getElementById('dailyMessageLimit').value) || 0;
      try {
        await apiRequest(`/devices/${machineId}/update-limits`, {
          method: 'POST',
          body: JSON.stringify({ totalMessageLimit: messageLimit, dailyMessageLimit })
        });
        closeModal();
        alert(`Message limits updated: ${messageLimit || 'unlimited'} total, ${dailyMessageLimit || 'unlimited'} daily`);
        refreshDevices();
      } catch (error) {
        alert(error.message || 'Failed to update message limits');
      }
    }

    async function banDevice(machineId) {
      const reason = prompt('Enter ban reason:');
      if (!reason) return;
      try {
        await apiRequest(`/devices/${machineId}/ban`, {
          method: 'POST',
          body: JSON.stringify({ reason })
        });
        alert('Device banned successfully');
        refreshDevices();
      } catch (error) {
        alert('Failed to ban device');
      }
    }

    async function unbanDevice(machineId) {
      if (!confirm('Are you sure you want to unban this device?')) return;
      try {
        await apiRequest(`/devices/${machineId}/unban`, { method: 'POST' });
        alert('Device unbanned successfully');
        refreshDevices();
      } catch (error) {
        alert('Failed to unban device');
      }
    }

    async function removeDevice(machineId) {
      if (!confirm('Are you sure you want to remove this device? This action cannot be undone.')) return;
      try {
        await apiRequest(`/devices/${machineId}`, { method: 'DELETE' });
        alert('Device removed successfully');
        refreshDevices();
      } catch (error) {
        alert('Failed to remove device');
      }
    }

    async function editDevice(machineId) {
      try {
        const device = await apiRequest(`/devices/${machineId}`);
        showModal('Edit Device', `
          <div class="form-group">
            <label class="form-label">Username:</label>
            <input type="text" class="form-input" id="editUsername" value="${device.username || ''}" placeholder="Username">
          </div>
          <div class="form-group">
            <label class="form-label">Name:</label>
            <input type="text" class="form-input" id="editName" value="${device.name || ''}" placeholder="Full name">
          </div>
          <div class="form-group">
            <label class="form-label">Email:</label>
            <input type="email" class="form-input" id="editEmail" value="${device.email || ''}" placeholder="Email address">
          </div>
          <div class="form-group">
            <label class="form-label">Mobile:</label>
            <input type="text" class="form-input" id="editMobile" value="${device.mobile || ''}" placeholder="Mobile number">
          </div>
        `, `
          <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveDeviceEdit('${machineId}')">Save Changes</button>
        `);
      } catch (error) {
        alert('Failed to load device details');
      }
    }

    async function saveDeviceEdit(machineId) {
      const username = document.getElementById('editUsername').value.trim();
      const name = document.getElementById('editName').value.trim();
      const email = document.getElementById('editEmail').value.trim();
      const mobile = document.getElementById('editMobile').value.trim();
      try {
        await apiRequest(`/devices/${machineId}`, {
          method: 'PUT',
          body: JSON.stringify({ username, name, email, mobile })
        });
        closeModal();
        alert('Device updated successfully');
        refreshDevices();
      } catch (error) {
        alert('Failed to update device');
      }
    }

    async function viewDeviceLogs(machineId) {
      try {
        const device = await apiRequest(`/devices/${machineId}`);
        let logsHtml = '<div style="max-height: 400px; overflow-y: auto;">';
        if (device.logs && device.logs.length > 0) {
          logsHtml += device.logs.map(log => `
            <div style="border-bottom: 1px solid var(--vercel-border); padding: 1rem 0;">
              <div style="font-weight: 600; color: var(--vercel-primary);">${log.type}</div>
              <div style="font-size: 0.875rem; color: var(--vercel-secondary); margin: 0.5rem 0;">
                ${new Date(log.timestamp).toLocaleString()}
                ${log.activatedBy ? ` • by ${log.activatedBy}` : ''}
              </div>
              ${log.details ? `<div style="font-size: 0.875rem;">${JSON.stringify(log.details, null, 2)}</div>` : ''}
            </div>
          `).join('');
        } else {
          logsHtml += '<div class="text-center">No logs found for this device</div>';
        }
        logsHtml += '</div>';
        showModal('Device Logs', logsHtml, '<button class="btn btn-outline" onclick="closeModal()">Close</button>');
      } catch (error) {
        alert('Failed to load device logs');
      }
    }

    async function exportDevices() {
      try {
        const response = await apiRequest('/devices?limit=1000');
        const devices = response.devices;
        const csvContent = [
          ['Machine ID', 'Username', 'Name', 'Email', 'Mobile', 'Platform', 'Status', 'License', 'Last Seen'].join(','),
          ...devices.map(device => [
            device.machineId,
            device.username || '',
            device.name || '',
            device.email || '',
            device.mobile || '',
            device.platform || '',
            device.isOnline ? 'Online' : 'Offline',
            getSubscriptionStatusText(device.subscriptionStatus),
            device.lastSeen
          ].join(','))
        ].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `devices_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (error) {
        alert('Failed to export devices');
      }
    }

    // --- License Management Page ---
    let currentLicensesPage = 1;
    let currentLicensesFilters = {};

    async function loadLicenses() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = '<div class="loading"></div>';
      try {
        mainContent.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">License Key Management</h3>
              <div class="card-actions">
                <button class="btn btn-outline" onclick="refreshLicenses()">
                  <i class="fas fa-sync-alt"></i>
                  Refresh
                </button>
                <button class="btn btn-success" onclick="generateLicenseModal()">
                  <i class="fas fa-plus"></i>
                  Generate
                </button>
                <button class="btn btn-primary" onclick="validateKeyModal()">
                  <i class="fas fa-check"></i>
                  Validate
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="flex items-center gap-2 mb-4">
                <select class="form-select" id="licenseStatusFilter" onchange="filterLicenses()" style="width: auto;">
                  <option value="">All Status</option>
                  <option value="available">Available</option>
                  <option value="used">Used</option>
                  <option value="expired">Expired</option>
                  <option value="deactivated">Deactivated</option>
                </select>
                <select class="form-select" id="licenseTypeFilter" onchange="filterLicenses()" style="width: auto;">
                  <option value="">All Types</option>
                  <option value="permanent">Permanent</option>
                  <option value="trial">Trial</option>
                </select>
                <input type="text" class="form-input" id="licenseSearchInput" placeholder="Search licenses..." onkeyup="searchLicenses()" style="width: 300px;">
              </div>
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Type</th>
                      <th>Status</th>
                      <th>Description</th>
                      <th>Created</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="licensesTableBody">
                    <tr><td colspan="6" class="text-center">Loading licenses...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div id="licensesPagination"></div>
                <div id="licensesCount"></div>
              </div>
            </div>
          </div>
        `;
        await refreshLicenses();
      } catch (error) {
        mainContent.innerHTML = '<div class="text-center">Error loading licenses page</div>';
      }
    }

    async function refreshLicenses() {
      try {
        const params = new URLSearchParams({
          page: currentLicensesPage,
          limit: 20,
          sortBy: 'createdAt',
          sortOrder: 'desc',
          ...currentLicensesFilters
        });
        const response = await apiRequest(`/licenses?${params}`);
        displayLicenses(response);
      } catch (error) {
        document.getElementById('licensesTableBody').innerHTML = '<tr><td colspan="6" class="text-center">Error loading licenses</td></tr>';
      }
    }

    function displayLicenses(data) {
      const tbody = document.getElementById('licensesTableBody');
      const pagination = document.getElementById('licensesPagination');
      const count = document.getElementById('licensesCount');
      if (!data.licenses || data.licenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No license keys found</td></tr>';
        pagination.innerHTML = '';
        count.innerHTML = '';
        return;
      }
      tbody.innerHTML = data.licenses.map(license => {
        const isExpired = license.expiresAt && new Date() > new Date(license.expiresAt);
        const isAvailable = !license.used && license.isActive && !isExpired;
        let statusClass = 'status-offline';
        let statusText = 'Unknown';
        if (!license.isActive) {
          statusClass = 'status-banned';
          statusText = 'Deactivated';
        } else if (isExpired) {
          statusClass = 'status-expired';
          statusText = 'Expired';
        } else if (license.used) {
          statusClass = 'status-active';
          statusText = 'Used';
        } else {
          statusClass = 'status-online';
          statusText = 'Available';
        }
        return `
          <tr>
            <td>${license.key}</td>
            <td>${license.type}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${license.description || ''}</td>
            <td>${new Date(license.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-outline" onclick="deactivateLicense('${license._id}')">Deactivate</button>
              <button class="btn btn-success" onclick="reactivateLicense('${license._id}')">Reactivate</button>
              <button class="btn btn-danger" onclick="deleteLicense('${license._id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
      const { page, pages, total } = data.pagination;
      let paginationHtml = '';
      if (pages > 1) {
        paginationHtml = '<div class="flex gap-2">';
        if (page > 1) {
          paginationHtml += `<button class="btn btn-outline" onclick="goToLicensesPage(${page - 1})">Previous</button>`;
        }
        for (let i = Math.max(1, page - 2); i <= Math.min(pages, page + 2); i++) {
          paginationHtml += `<button class="btn ${i === page ? 'btn-primary' : 'btn-outline'}" onclick="goToLicensesPage(${i})">${i}</button>`;
        }
        if (page < pages) {
          paginationHtml += `<button class="btn btn-outline" onclick="goToLicensesPage(${page + 1})">Next</button>`;
        }
        paginationHtml += '</div>';
      }
      pagination.innerHTML = paginationHtml;
      count.innerHTML = `Showing ${data.licenses.length} of ${total} license keys`;
    }

    function goToLicensesPage(page) {
      currentLicensesPage = page;
      refreshLicenses();
    }

    function filterLicenses() {
      const status = document.getElementById('licenseStatusFilter').value;
      const type = document.getElementById('licenseTypeFilter').value;
      currentLicensesFilters = {};
      if (status) currentLicensesFilters.status = status;
      if (type) currentLicensesFilters.type = type;
      currentLicensesPage = 1;
      refreshLicenses();
    }

    function searchLicenses() {
      const search = document.getElementById('licenseSearchInput').value.trim();
      if (search) {
        currentLicensesFilters.search = search;
      } else {
        delete currentLicensesFilters.search;
      }
      currentLicensesPage = 1;
      refreshLicenses();
    }

    // License actions, modals, and related functions (from backup)
    // ...existing code from backup for generateLicenseModal, generateLicenseKeys, validateKeyModal, validateLicenseKey, deactivateLicense, reactivateLicense, deleteLicense...

    // Utility functions
    function getSubscriptionStatusClass(status) {
      const statusMap = {
        'active': 'active',
        'permanent': 'active',
        'expired': 'expired',
        'expiring_soon': 'warning',
        'expiring_warning': 'warning',
        'banned': 'error',
        'inactive': 'offline'
      };
      return statusMap[status] || 'offline';
    }

    function getSubscriptionStatusText(status) {
      const statusMap = {
        'active': 'Active',
        'permanent': 'Permanent',
        'expired': 'Expired',
        'expiring_soon': 'Expiring',
        'expiring_warning': 'Expiring',
        'banned': 'Banned',
        'inactive': 'Inactive'
      };
      return statusMap[status] || 'Unknown';
    }

    function formatTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffMinutes < 1) return 'Just now';
      if (diffMinutes < 60) return `${diffMinutes}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${diffDays}d ago`;
    }

    async function apiRequest(endpoint, options = {}) {
      const url = `${API_BASE}${endpoint}`;
      const config = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        ...options
      };
      
      const response = await fetch(url, config);
      
      if (response.status === 401) {
        logout();
        return;
      }
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return await response.json();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUsername');
      window.location.href = '/admin-login-secure.html';
    }

    function showModal(title, body, footer) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = body;
      if (footer) {
        document.getElementById('modalFooter').innerHTML = footer;
      }
      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.add('hidden');
    }
  </script>
</body>
</html>
